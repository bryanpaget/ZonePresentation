name: Deploy Marp Slides to GitHub Pages
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
permissions:
  contents: read
  pages: write
  id-token: write
jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      pdfs-built: ${{ steps.verify.outputs.pdfs-built }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          
      - name: Install Marp CLI
        run: npm install -g @marp-team/marp-cli
        
      - name: Create combined markdown files
        run: |
          # Create temp directory
          mkdir -p temp
          # Combine header + content for English
          cat config/header.md content/slides-en.md > temp/slides-en-combined.md
          # Combine header + content for French
          cat config/header.md content/slides-fr.md > temp/slides-fr-combined.md
          
      - name: Build PDFs
        run: |
          marp temp/slides-en-combined.md --pdf --output slides-en.pdf --allow-local-files
          marp temp/slides-fr-combined.md --pdf --output slides-fr.pdf --allow-local-files
          
      - name: Verify PDFs exist
        id: verify
        run: |
          if [ -f slides-en.pdf ] && [ -f slides-fr.pdf ]; then
            echo "pdfs-built=true" >> $GITHUB_OUTPUT
            echo "PDFs built successfully"
          else
            echo "PDFs not built!"
            exit 1
          fi
          
      - name: Upload PDFs artifact
        uses: actions/upload-artifact@v4
        with:
          name: slides-pdfs
          path: |
            slides-en.pdf
            slides-fr.pdf
          retention-days: 30
          
  publish:
    needs: build
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          
      - name: Install Marp CLI
        run: npm install -g @marp-team/marp-cli
        
      - name: Create output directories
        run: |
          mkdir -p public
          mkdir -p public/img
          
      - name: Copy images to public directory
        run: cp -r img/* public/img/
        
      - name: Create combined markdown files
        run: |
          mkdir -p temp
          cat config/header.md content/slides-en.md > temp/slides-en-combined.md
          cat config/header.md content/slides-fr.md > temp/slides-fr-combined.md
          
      - name: Generate English HTML
        run: |
          marp temp/slides-en-combined.md \
            --html \
            --output public/index.html \
            --allow-local-files
            
      - name: Generate French HTML
        run: |
          marp temp/slides-fr-combined.md \
            --html \
            --output public/fr.html \
            --allow-local-files
            
      - name: List public directory
        run: ls -la public/
        
      - name: Setup Pages
        uses: actions/configure-pages@v4
        
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public
          
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        
  release:
    needs: [build, publish]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write
    steps:
      - name: Download PDFs artifact
        uses: actions/download-artifact@v4
        with:
          name: slides-pdfs
          path: .
          
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: The Zone Presentation v${{ github.run_number }}
          body: |
            # Welcome to The Zone Presentation!

            Dear Zone Friends,

            We're pleased to share the latest version of our presentation on The Zone - Statistics Canada's modern data science platform. This release represents our ongoing commitment to providing innovative, secure, and efficient tools for data science across the organization.

            ## What's Included
            - `slides-en.pdf`: English version of the presentation
            - `slides-fr.pdf`: French version of the presentation

            ## Acknowledgments
            This presentation is the result of collaborative efforts across multiple teams. We extend our gratitude to everyone who contributed their time, expertise, and feedback to make this resource possible.

            ## Questions or Feedback?
            For any questions about The Zone or this presentation, please reach out to The Zone Team. We're always happy to discuss how this platform can support your data science initiatives.

            ---
          files: |
            slides-en.pdf
            slides-fr.pdf
